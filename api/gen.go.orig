// Copyright 2020 The NATS Authors
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

//go:build ignore
// +build ignore

package main

import (
	"encoding/base64"
	"encoding/json"
	"fmt"
	"io"
	"log"
	"net/http"
	"os"
	"os/exec"
	"sort"
	"strings"
	"text/template"
	"time"

	"github.com/nats-io/jsm.go/api"
	scfs "github.com/nats-io/jsm.go/schemas"
)

var schemasFileTemplate = `// auto generated {{.Now}}

package api

import (
	srvadvisory "github.com/nats-io/jsm.go/api/server/advisory"
	srvmetric "github.com/nats-io/jsm.go/api/server/metric"
	jsadvisory "github.com/nats-io/jsm.go/api/jetstream/advisory"
    jsmetric "github.com/nats-io/jsm.go/api/jetstream/metric"
    scfs "github.com/nats-io/jsm.go/schemas"
	"github.com/nats-io/nats.go/micro"
)

var schemaTypes = map[string]func() any {
{{- range . }}
{{- if .St }}
    "{{ .T }}": func() any { return &{{ .St }}{} },
{{- end }}
{{- end }}
	"io.nats.unknown_message": func() any { return &UnknownMessage{} },
}

var schemaRequestSubjects = map[string]func() any {
{{- range . }}
{{- if .Req }}
    {{ .Req }}: func() any { return &{{ .St }}{} },
{{- end }}
{{- end }}
}

var schemaResponseSubjects = map[string]func() any {
{{- range . }}
{{- if .Res }}
    {{ .Res }}: func() any { return &{{ .St }}{} },
{{- end }}
{{- end }}
}

var schemaWildcardSubjects = map[string]func() any {
{{- range . }}
{{- if .W }}
    {{ .W }}: func() any { return &{{ .St }}{} },
{{- end }}
{{- end }}
}

{{- range . }}
{{- if .ShouldAddValidator }}
// Validate performs a JSON Schema validation of the configuration
func (t {{ .St }}) Validate(v ...StructValidator) (valid bool, errors []string) {
	if len(v) == 0 || v[0] == nil {
		return true, nil
	}

	return v[0].ValidateStruct(t, t.SchemaType())
}

// SchemaType is the NATS schema type {{ .T }}
func (t {{ .St }}) SchemaType() string {
	return "{{ .T }}"
}

// SchemaID is the url to the JSON Schema for JetStream Consumer Configuration
func (t {{ .St }}) SchemaID() string {
	return "{{ .SchemaURL }}"
}

// Schema is a JSON Schema document for the JetStream Consumer Configuration
func (t {{ .St }}) Schema() ([]byte, error) {
	f, err := SchemaFileForType(t.SchemaType())
	if err != nil {
		return nil, err
	}
	return scfs.Load(f)
}

{{- end }}
{{- end }}
`

type validator interface {
	Validate() (valid bool, errors []string)
	SchemaType() string
	SchemaID() string
	Schema() []byte
}

type schema struct {
	T   string // type
	S   string // schema
	P   string // path
	St  string // struct
	Req string // request subject
	Res string // response subject
	W   string // wildcard subject
}

// ShouldAddValidator only adds validator logic for package local structs
func (s schema) ShouldAddValidator() bool {
	return !strings.Contains(s.St, ".")
}

func (s schema) SchemaURL() string {
	t, _, err := api.SchemaURLForType(s.T)
	if err != nil {
		panic(err)
	}

	return t
}

type schemas []*schema

type idDetect struct {
	ID    string `json:"$id"`
	Title string `json:"title"`
}

func (s schemas) Now() string {
	return fmt.Sprintf("%s", time.Now())
}

func panicIfErr(err error) {
	if err != nil {
		panic(err)
	}
}

func goFmt(file string) error {
	c := exec.Command("goimports", "-w", file)
	out, err := c.CombinedOutput()
	if err != nil {
		log.Printf("goimports failed: %s", string(out))
	}

	c = exec.Command("go", "fmt", file)
	out, err = c.CombinedOutput()
	if err != nil {
		log.Printf("go fmt failed: %s", string(out))
	}

	return err
}

func fetchErrors() error {
	resp, err := http.Get("https://raw.githubusercontent.com/nats-io/nats-server/main/server/errors.json")
	if err != nil {
		return err
	}
	defer resp.Body.Close()

	out, err := os.Create("schemas/server/errors.json")
	if err != nil {
		return err
	}
	defer out.Close()

	_, err = io.Copy(out, resp.Body)
	return err
}

func getSchema(u string) (title string, id string, body string, err error) {
	log.Printf("Fetching %s", u)

	f, err := api.SchemaFileForType("io.nats." + strings.TrimSuffix(strings.ReplaceAll(u, "/", "."), ".json"))
	panicIfErr(err)
	data, err := scfs.Load(f)
	panicIfErr(err)

	idt := &idDetect{}
	err = json.Unmarshal(data, idt)
	panicIfErr(err)

	log.Printf("Detected %+v", *idt)
	return idt.Title, idt.ID, base64.StdEncoding.EncodeToString(data), nil
}

func main() {
	s := schemas{
		&schema{P: "jetstream/advisory/v1/api_audit.json", St: "jsadvisory.JetStreamAPIAuditV1"},
		&schema{P: "jetstream/advisory/v1/stream_batch_abandoned.json", St: "jsadvisory.JSStreamBatchAbandonedAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/consumer_action.json", St: "jsadvisory.JSConsumerActionAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/consumer_group_pinned.json", St: "jsadvisory.JSConsumerGroupPinnedAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/consumer_group_unpinned.json", St: "jsadvisory.JSConsumerGroupUnPinnedAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/consumer_leader_elected.json", St: "jsadvisory.JSConsumerLeaderElectedV1"},
		&schema{P: "jetstream/advisory/v1/consumer_pause.json", St: "jsadvisory.JSConsumerPauseAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/consumer_quorum_lost.json", St: "jsadvisory.JSConsumerQuorumLostV1"},
		&schema{P: "jetstream/advisory/v1/domain_leader_elected.json", St: "jsadvisory.JSDomainLeaderElectedV1"},
		&schema{P: "jetstream/advisory/v1/max_deliver.json", St: "jsadvisory.ConsumerDeliveryExceededAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/nak.json", St: "jsadvisory.JSConsumerDeliveryNakAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/restore_complete.json", St: "jsadvisory.JSRestoreCompleteAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/restore_create.json", St: "jsadvisory.JSRestoreCreateAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/server_out_of_space.json", St: "jsadvisory.JSServerOutOfSpaceAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/server_removed.json", St: "jsadvisory.JSServerRemovedAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/snapshot_complete.json", St: "jsadvisory.JSSnapshotCompleteAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/snapshot_create.json", St: "jsadvisory.JSSnapshotCreateAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/stream_action.json", St: "jsadvisory.JSStreamActionAdvisoryV1"},
		&schema{P: "jetstream/advisory/v1/stream_leader_elected.json", St: "jsadvisory.JSStreamLeaderElectedV1"},
		&schema{P: "jetstream/advisory/v1/stream_quorum_lost.json", St: "jsadvisory.JSStreamQuorumLostV1"},
		&schema{P: "jetstream/advisory/v1/terminated.json", St: "jsadvisory.JSConsumerDeliveryTerminatedAdvisoryV1"},
		&schema{P: "jetstream/api/v1/account_info_response.json", St: "JSApiAccountInfoResponse", Res: "JSApiAccountInfoPrefix"},
		&schema{P: "jetstream/api/v1/account_purge_response.json", St: "JSApiAccountPurgeResponse", Res: "JSApiAccountPurgePrefix"},
		&schema{P: "jetstream/api/v1/consumer_configuration.json", St: "ConsumerConfig"},
		&schema{P: "jetstream/api/v1/consumer_create_request.json", St: "JSApiConsumerCreateRequest", Req: "JSApiConsumerCreateWithNamePrefix"},
		&schema{P: "jetstream/api/v1/consumer_create_response.json", St: "JSApiConsumerCreateResponse", Res: "JSApiConsumerCreatePrefix"},
		&schema{P: "jetstream/api/v1/consumer_delete_response.json", St: "JSApiConsumerDeleteResponse", Res: "JSApiConsumerDeletePrefix"},
		&schema{P: "jetstream/api/v1/consumer_getnext_request.json", St: "JSApiConsumerGetNextRequest", Req: "JSApiRequestNextPrefix"},
		&schema{P: "jetstream/api/v1/consumer_info_response.json", St: "JSApiConsumerInfoResponse", Res: "JSApiConsumerInfoPrefix"},
		&schema{P: "jetstream/api/v1/consumer_leader_stepdown_request.json", St: "JSApiConsumerLeaderStepdownRequest", Req: "JSApiConsumerLeaderStepDownPrefix"},
		&schema{P: "jetstream/api/v1/consumer_leader_stepdown_response.json", St: "JSApiConsumerLeaderStepDownResponse", Res: "JSApiConsumerLeaderStepDownPrefix"},
		&schema{P: "jetstream/api/v1/consumer_list_request.json", St: "JSApiConsumerListRequest", Req: "JSApiConsumerListPrefix"},
		&schema{P: "jetstream/api/v1/consumer_list_response.json", St: "JSApiConsumerListResponse", Res: "JSApiConsumerListPrefix"},
		&schema{P: "jetstream/api/v1/consumer_names_request.json", St: "JSApiConsumerNamesRequest", Req: "JSApiConsumerNamesPrefix"},
		&schema{P: "jetstream/api/v1/consumer_names_response.json", St: "JSApiConsumerNamesResponse", Res: "JSApiConsumerNamesPrefix"},
		&schema{P: "jetstream/api/v1/consumer_pause_request.json", St: "JSApiConsumerPauseRequest", Req: "JSApiConsumerPausePrefix"},
		&schema{P: "jetstream/api/v1/consumer_pause_response.json", St: "JSApiConsumerPauseResponse", Res: "JSApiConsumerPausePrefix"},
		&schema{P: "jetstream/api/v1/consumer_unpin_request.json", St: "JSApiConsumerUnpinRequest", Req: "JSApiConsumerUnpinPrefix"},
		&schema{P: "jetstream/api/v1/consumer_unpin_response.json", St: "JSApiConsumerUnpinResponse", Res: "JSApiConsumerUnpinPrefix"},
		&schema{P: "jetstream/api/v1/meta_leader_stepdown_request.json", St: "JSApiLeaderStepDownRequest", Req: "JSApiLeaderStepDownPrefix"},
		&schema{P: "jetstream/api/v1/meta_leader_stepdown_response.json", St: "JSApiLeaderStepDownResponse", Res: "JSApiLeaderStepDownPrefix"},
		&schema{P: "jetstream/api/v1/meta_server_remove_request.json", St: "JSApiMetaServerRemoveRequest", Req: "JSApiServerRemovePrefix"},
		&schema{P: "jetstream/api/v1/meta_server_remove_response.json", St: "JSApiMetaServerRemoveResponse", Res: "JSApiServerRemovePrefix"},
		&schema{P: "jetstream/api/v1/pub_ack_response.json", St: "JSPubAckResponse", Res: "JSAckPrefix"},
		&schema{P: "jetstream/api/v1/stream_configuration.json", St: "StreamConfig"},
		&schema{P: "jetstream/api/v1/stream_create_request.json", St: "JSApiStreamCreateRequest", Req: "JSApiStreamCreatePrefix"},
		&schema{P: "jetstream/api/v1/stream_create_response.json", St: "JSApiStreamCreateResponse", Res: "JSApiStreamCreatePrefix"},
		&schema{P: "jetstream/api/v1/stream_delete_response.json", St: "JSApiStreamDeleteResponse", Res: "JSApiStreamDeletePrefix"},
		&schema{P: "jetstream/api/v1/stream_info_request.json", St: "JSApiStreamInfoRequest", Req: "JSApiStreamInfoPrefix"},
		&schema{P: "jetstream/api/v1/stream_info_response.json", St: "JSApiStreamInfoResponse", Res: "JSApiStreamInfoPrefix"},
		&schema{P: "jetstream/api/v1/stream_leader_stepdown_request.json", St: "JSApiStreamLeaderStepDownRequest", Req: "JSApiStreamLeaderStepDownPrefix"},
		&schema{P: "jetstream/api/v1/stream_leader_stepdown_response.json", St: "JSApiStreamLeaderStepDownResponse", Res: "JSApiStreamLeaderStepDownPrefix"},
		&schema{P: "jetstream/api/v1/stream_list_request.json", St: "JSApiStreamListRequest", Req: "JSApiStreamListPrefix"},
		&schema{P: "jetstream/api/v1/stream_list_response.json", St: "JSApiStreamListResponse", Res: "JSApiStreamListPrefix"},
		&schema{P: "jetstream/api/v1/stream_msg_delete_request.json", St: "JSApiMsgDeleteRequest", Req: "JSApiMsgDeletePrefix"},
		&schema{P: "jetstream/api/v1/stream_msg_delete_response.json", St: "JSApiMsgDeleteResponse", Res: "JSApiMsgDeletePrefix"},
		&schema{P: "jetstream/api/v1/stream_msg_get_request.json", St: "JSApiMsgGetRequest", Req: "JSApiMsgGetPrefix"},
		&schema{P: "jetstream/api/v1/stream_msg_get_response.json", St: "JSApiMsgGetResponse", Res: "JSApiMsgGetPrefix"},
		&schema{P: "jetstream/api/v1/stream_names_request.json", St: "JSApiStreamNamesRequest", Req: "JSApiStreamNamesPrefix"},
		&schema{P: "jetstream/api/v1/stream_names_response.json", St: "JSApiStreamNamesResponse", Res: "JSApiStreamNamesPrefix"},
		&schema{P: "jetstream/api/v1/stream_purge_request.json", St: "JSApiStreamPurgeRequest", Req: "JSApiStreamPurgePrefix"},
		&schema{P: "jetstream/api/v1/stream_purge_response.json", St: "JSApiStreamPurgeResponse", Res: "JSApiStreamPurgePrefix"},
		&schema{P: "jetstream/api/v1/stream_remove_peer_request.json", St: "JSApiStreamRemovePeerRequest", Req: "JSApiStreamRemovePeerPrefix"},
		&schema{P: "jetstream/api/v1/stream_remove_peer_response.json", St: "JSApiStreamRemovePeerResponse", Res: "JSApiStreamRemovePeerPrefix"},
		&schema{P: "jetstream/api/v1/stream_restore_request.json", St: "JSApiStreamRestoreRequest", Req: "JSApiStreamRestorePrefix"},
		&schema{P: "jetstream/api/v1/stream_restore_response.json", St: "JSApiStreamRestoreResponse", Res: "JSApiStreamRestorePrefix"},
		&schema{P: "jetstream/api/v1/stream_snapshot_request.json", St: "JSApiStreamSnapshotRequest", Req: "JSApiStreamSnapshotPrefix"},
		&schema{P: "jetstream/api/v1/stream_snapshot_response.json", St: "JSApiStreamSnapshotResponse", Res: "JSApiStreamSnapshotPrefix"},
		&schema{P: "jetstream/api/v1/stream_update_request.json", St: "JSApiStreamUpdateRequest", Req: "JSApiStreamUpdatePrefix"},
		&schema{P: "jetstream/api/v1/stream_update_response.json", St: "JSApiStreamUpdateResponse", Res: "JSApiStreamUpdatePrefix"},
		&schema{P: "jetstream/metric/v1/consumer_ack.json", St: "jsmetric.ConsumerAckMetricV1"},
		&schema{P: "micro/v1/info_response.json", St: "micro.Info"},
		&schema{P: "micro/v1/ping_response.json", St: "micro.Ping"},
		&schema{P: "micro/v1/stats_response.json", St: "micro.Stats"},
		&schema{P: "server/advisory/v1/account_connections.json", St: "srvadvisory.AccountConnectionsV1"},
		&schema{P: "server/advisory/v1/client_connect.json", St: "srvadvisory.ConnectEventMsgV1"},
		&schema{P: "server/advisory/v1/client_disconnect.json", St: "srvadvisory.DisconnectEventMsgV1"},
		&schema{P: "server/metric/v1/service_latency.json", St: "srvmetric.ServiceLatencyV1"},
		&schema{P: "server/monitor/v1/varz.json", St: "zmonitor.VarzV1"},
	}

	for _, i := range s {
		title, _, body, err := getSchema(i.P)
		panicIfErr(err)

		i.S = body
		if i.T == "" {
			i.T = title
		}

		if i.Req != "" {
			i.W = strings.TrimSuffix(i.Req, "Prefix")
		}
	}

	sort.Slice(s, func(i, j int) bool { return s[i].P < s[j].P })

	t, err := template.New("schemas").Parse(schemasFileTemplate)
	panicIfErr(err)

	out, err := os.Create("api/schemas_generated.go")
	panicIfErr(err)

	err = t.Execute(out, s)
	panicIfErr(err)

	out.Close()
	err = goFmt(out.Name())
	panicIfErr(err)

	panicIfErr(fetchErrors())
}
